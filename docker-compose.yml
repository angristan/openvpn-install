---
services:
  openvpn-server:
    build:
      context: .
      dockerfile: test/Dockerfile.server
    container_name: openvpn-server
    hostname: openvpn-server
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
    volumes:
      - shared-config:/shared
    networks:
      vpn-test:
        ipv4_address: 172.28.0.10
      external-test:
        ipv4_address: 172.29.0.10
    healthcheck:
      test: ["CMD", "pgrep", "openvpn"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 60s

  openvpn-client:
    build:
      context: .
      dockerfile: test/Dockerfile.client
    container_name: openvpn-client
    hostname: openvpn-client
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - shared-config:/shared:ro
    networks:
      vpn-test:
        ipv4_address: 172.28.0.20
    depends_on:
      openvpn-server:
        condition: service_healthy

  # External service only reachable via VPN server's NAT
  httpbin:
    image: kennethreitz/httpbin
    container_name: httpbin
    hostname: httpbin
    networks:
      external-test:
        ipv4_address: 172.29.0.100
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/ip"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

volumes:
  shared-config:

networks:
  vpn-test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
  external-test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/24
